<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscador de Pel√≠culas TMDb</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    input, button, select {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    #resultado {
      margin-top: 20px;
      white-space: pre-wrap;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
    }
    #poster {
      max-width: 200px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Buscador de Pel√≠culas TMDb</h1>
  <label for="titulo">T√≠tulo:</label>
  <input type="text" id="titulo" placeholder="Ej. Jurassic World">
  <label for="anio">A√±o:</label>
  <input type="number" id="anio" placeholder="2025" min="1900" max="2099">
  <br>
  <label for="url">URL:</label>
  <input type="text" id="url" size="80" placeholder="Pega aqu√≠ el enlace">
  <br>
  <button onclick="buscar()">Buscar</button>
  <button onclick="limpiar()">Limpiar campos</button>
  <button onclick="copiar()">Copiar resultado</button>

  <div>
    <select id="peliculas" onchange="seleccionarPelicula(this.value)">
      <option value="">-- Selecciona una pel√≠cula --</option>
    </select>
  </div>

  <img id="poster" src="" alt="P√≥ster">
  <div id="resultado"></div>

  <script>
    const apiKey = "f4f4f4f4f4f4f4f4f4f4f4f4f4f4f4f4"; // Reemplaza con tu clave real

    function limpiarFileToLink(url) {
      if (url.startsWith("https://filetolink")) {
        try {
          const u = new URL(url);
          const parts = u.pathname.split("/");
          if (parts.length >= 4 && parts[1] === "download") {
            u.pathname = `/${parts[2]}/`;
            return u.origin + u.pathname + u.search;
          }
        } catch (e) {
          console.warn("URL inv√°lida:", e);
        }
      }
      return url;
    }

    async function buscar() {
      const titulo = document.getElementById("titulo").value.trim();
      const anio = document.getElementById("anio").value.trim();
      const url = document.getElementById("url").value.trim();
      if (!titulo || !url) {
        alert("Por favor, completa t√≠tulo y URL.");
        return;
      }

      const query = `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(titulo)}&year=${anio}`;
      const resp = await fetch(query);
      const data = await resp.json();

      const select = document.getElementById("peliculas");
      select.innerHTML = '<option value="">-- Selecciona una pel√≠cula --</option>';
      data.results.forEach((pelicula, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = `${pelicula.title} (${pelicula.release_date?.slice(0, 4) || "?"})`;
        select.appendChild(option);
      });

      if (data.results.length > 0) {
        seleccionarPelicula(0);
      } else {
        document.getElementById("resultado").textContent = "No se encontraron resultados.";
        document.getElementById("poster").src = "";
      }
    }

    function seleccionarPelicula(index) {
      const titulo = document.getElementById("titulo").value.trim();
      const url = document.getElementById("url").value.trim();
      const anio = document.getElementById("anio").value.trim();
      const select = document.getElementById("peliculas");
      const idx = parseInt(index);
      if (isNaN(idx)) return;

      const query = `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(titulo)}&year=${anio}`;
      fetch(query)
        .then(resp => resp.json())
        .then(data => {
          const pelicula = data.results[idx];
          const sinopsis = pelicula.overview.length > 300 ? pelicula.overview.slice(0, 300) + "..." : pelicula.overview;
          const posterUrl = pelicula.poster_path ? `https://image.tmdb.org/t/p/w500${pelicula.poster_path}` : "";

          document.getElementById("poster").src = posterUrl;

          const urlFinal = limpiarFileToLink(url);
          const enlace = `http://labutacaroja.github.io/?video=${encodeURIComponent(urlFinal)}&title=${encodeURIComponent(pelicula.title)}`;

          const resultado = `üé¨ *${pelicula.title}* (${pelicula.release_date?.slice(0, 4) || "?"})\nüìù ${sinopsis}\nüìé ${enlace}`;
          document.getElementById("resultado").textContent = resultado;
        });
    }

    function limpiar() {
      document.getElementById("titulo").value = "";
      document.getElementById("anio").value = "";
      document.getElementById("url").value = "";
      document.getElementById("resultado").textContent = "";
      document.getElementById("poster").src = "";
      document.getElementById("peliculas").innerHTML = '<option value="">-- Selecciona una pel√≠cula --</option>';
    }

    function copiar() {
      const texto = document.getElementById("resultado").textContent;
      navigator.clipboard.writeText(texto).then(() => {
        alert("Resultado copiado al portapapeles.");
      });
    }
  </script>
</body>
</html>
