<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Buscador de Pel√≠culas TMDb</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
    }
    input, select, button {
      margin: 5px 0;
      padding: 8px;
      font-size: 14px;
    }
    .button-container {
      margin: 10px 0;
    }
    #poster {
      display: none;
      width: 200px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    #opciones-year {
      margin-bottom: 10px;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h1>Buscador de Pel√≠culas TMDb</h1>

  <label for="titulo">T√≠tulo:</label><br>
  <input type="text" id="titulo" placeholder="Ej: Jurassic World: El renacer"><br>

  <label for="yearFrom">A√±o desde:</label>
  <input type="number" id="yearFrom" placeholder="2020" min="1900" max="2100">
  <label for="yearTo">A√±o hasta:</label>
  <input type="number" id="yearTo" placeholder="2025" min="1900" max="2100"><br>

  <label for="url">URL:</label><br>
  <input type="text" id="url"
         placeholder="Ej: https://filetolink.com/download/1234/video.mkv"><br>

  <div class="button-container">
    <button onclick="buscarPelicula()">Buscar</button>
    <button onclick="limpiarCampos()">Limpiar campos</button>
  </div>

  <h2>Resultado:</h2>
  <img id="poster" alt="P√≥ster de la pel√≠cula"/>
  <div id="opciones-year"></div>
  <pre id="resultado"></pre><br>
  <button onclick="copiarAlPortapapeles()">Copiar resultados</button>

  <script>
    // placeholder, si usas proxy o servicio espec√≠fico
    async function resolveStreamUrl(url) {
      return url;
    }

    // Elimina el primer "/download/" de cualquier URL que comience por "https://filetolink"
    function stripDownload(url) {
      const prefix = 'https://filetolink';
      if (url.startsWith(prefix)) {
        // reemplaza "/download/" por "/" (solo la carpeta download)
        return url.replace('/download/', '/');
      }
      return url;
    }

    async function buscarPelicula() {
      limpiarInterfaz();
      const tituloInput = document.getElementById("titulo").value.trim();
      const rawUrl      = document.getElementById("url").value.trim();
      const yearFrom    = parseInt(document.getElementById("yearFrom").value);
      const yearTo      = parseInt(document.getElementById("yearTo").value);

      if (!tituloInput || !rawUrl) {
        alert('Debes rellenar t√≠tulo y URL.');
        return;
      }

      // 1) Resolver stream (si aplica)
      const resolved = await resolveStreamUrl(rawUrl);

      // 2) Limpiar "/download/" en URLs filetolink
      const videoUrl = stripDownload(resolved);

      // 3) Llamada a TMDb
      const api_key = "d336c933823098e7d4f5221b2eb3d768";
      const resp = await fetch(
        `https://api.themoviedb.org/3/search/movie?api_key=${api_key}`
        + `&query=${encodeURIComponent(tituloInput)}&language=es`
      );
      const data = await resp.json();

      if (!data.results.length) {
        mostrarMensaje(`No se encontr√≥ ninguna pel√≠cula con "${tituloInput}".`);
        return;
      }

      // 4) Filtrar por a√±o si hay rango
      let resultados = data.results.filter(movie => {
        if (!movie.release_date) return false;
        const y = parseInt(movie.release_date.split("-")[0], 10);
        if (yearFrom && yearTo) return y >= yearFrom && y <= yearTo;
        if (yearFrom) return y >= yearFrom;
        if (yearTo) return y <= yearTo;
        return true;
      });

      if (!resultados.length) {
        mostrarMensaje(`No hay resultados en el rango ${yearFrom||'‚àû'}‚Äì${yearTo||'‚àû'}.`);
        return;
      }

      // 5) Si hay varias sin filtros de a√±o, que elija
      if (!yearFrom && !yearTo && resultados.length > 1) {
        mostrarOpcionesYear(resultados, videoUrl);
        return;
      }

      // 6) Mostrar directamente el primer resultado
      mostrarResultado(resultados[0], videoUrl);
    }

    function limpiarInterfaz() {
      document.getElementById("poster").style.display   = "none";
      document.getElementById("opciones-year").innerHTML = "";
      document.getElementById("resultado").innerText    = "";
    }

    function mostrarMensaje(texto) {
      limpiarInterfaz();
      document.getElementById("resultado").innerText = texto;
    }

    function mostrarOpcionesYear(lista, videoUrl) {
      limpiarInterfaz();
      const cont = document.getElementById("opciones-year");
      const select = document.createElement("select");
      select.style.padding = "5px";

      lista.forEach(movie => {
        const y = movie.release_date.split("-")[0];
        const opt = document.createElement("option");
        opt.value = movie.id;
        opt.text  = `${movie.title} (${y})`;
        select.appendChild(opt);
      });
      cont.appendChild(select);

      const btn = document.createElement("button");
      btn.textContent = "Seleccionar";
      btn.style.marginLeft = "8px";
      btn.onclick = () => {
        const selId = parseInt(select.value, 10);
        const movie = lista.find(m => m.id === selId);
        mostrarResultado(movie, videoUrl);
      };
      cont.appendChild(btn);
    }

    function mostrarResultado(movie, videoUrl) {
      limpiarInterfaz();

      // P√≥ster
      if (movie.poster_path) {
        const img = document.getElementById("poster");
        img.src = `https://image.tmdb.org/t/p/w500${movie.poster_path}`;
        img.style.display = "block";
      }

      // Sinopsis
      let overview = movie.overview || "Sinopsis no disponible";
      if (overview.length > 570) {
        overview = overview.substring(0, 567) + "...";
      }

      // Formato de t√≠tulo: espacios ‚Üí guiones bajos, mantengo ":" y otros s√≠mbolos
      const year = movie.release_date.split("-")[0];
      const formattedTitle = movie.title.replace(/\s+/g, "_") + `(${year})`;

      // Construcci√≥n del texto sin encoding extra
      const resultadoTexto =
        `üìÇ T√≠tulo : \`${movie.title} (${year})\`\n\n`
        + `${overview}\n\n`
        + `http://labutacaroja.github.io/?video=${videoUrl}`
        + `&title=${formattedTitle}`;

      document.getElementById("resultado").innerText = resultadoTexto;
    }

    function limpiarCampos() {
      ["titulo","yearFrom","yearTo","url"].forEach(id => {
        document.getElementById(id).value = "";
      });
      limpiarInterfaz();
    }

    function copiarAlPortapapeles() {
      const txt = document.getElementById("resultado").innerText;
      navigator.clipboard.writeText(txt);
    }
  </script>
</body>
</html>
