<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscador de PelÃ­culas TMDb</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
    }
    input, select, button {
      margin: 5px 0;
      padding: 8px;
      font-size: 14px;
    }
    .button-container {
      margin: 10px 0;
    }
    #poster {
      display: none;
      width: 200px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    #opciones-year {
      margin-bottom: 10px;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Buscador de PelÃ­culas TMDb</h1>

  <label for="titulo">TÃ­tulo:</label><br>
  <input type="text" id="titulo" placeholder="Ej: Â¿DÃ³nde estÃ¡ mamÃ¡"><br>

  <label for="yearFrom">AÃ±o desde:</label>
  <input type="number" id="yearFrom" placeholder="2020" min="1900" max="2100">
  <label for="yearTo">AÃ±o hasta:</label>
  <input type="number" id="yearTo" placeholder="2023" min="1900" max="2100"><br>

  <label for="url">URL:</label><br>
  <input type="text" id="url" placeholder="Ej: https://ejemplo.com/video.mp4"><br>

  <div class="button-container">
    <button onclick="buscarPelicula()">Buscar</button>
    <button onclick="limpiarCampos()">Limpiar campos</button>
  </div>

  <h2>Resultado:</h2>

  <img id="poster" alt="PÃ³ster de la pelÃ­cula" />
  <div id="opciones-year"></div>
  <pre id="resultado"></pre><br>
  <button onclick="copiarAlPortapapeles()">Copiar resultados</button>

  <script>
    // Si tienes un servicio para resolver URL de streaming, reemplaza esta funciÃ³n.
    async function resolveStreamUrl(url) {
      return url;
    }

    async function buscarPelicula() {
      limpiarInterfaz();
      const tituloInput = document.getElementById("titulo").value.trim();
      const urlInputRaw = document.getElementById("url").value.trim();
      const yearFrom = parseInt(document.getElementById("yearFrom").value);
      const yearTo   = parseInt(document.getElementById("yearTo").value);

      if (!tituloInput || !urlInputRaw) {
        alert('Debes rellenar tÃ­tulo y URL.');
        return;
      }

      const urlInput = await resolveStreamUrl(urlInputRaw);
      const api_key = "d336c933823098e7d4f5221b2eb3d768";
      const resp = await fetch(
        `https://api.themoviedb.org/3/search/movie?api_key=${api_key}`
        + `&query=${encodeURIComponent(tituloInput)}&language=es`
      );
      const data = await resp.json();

      if (!data.results.length) {
        mostrarMensaje(`No se encontrÃ³ ninguna pelÃ­cula con "${tituloInput}".`);
        return;
      }

      let resultados = data.results.filter(movie => {
        if (!movie.release_date) return false;
        const y = parseInt(movie.release_date.split("-")[0]);
        if (yearFrom && yearTo) return y >= yearFrom && y <= yearTo;
        if (yearFrom) return y >= yearFrom;
        if (yearTo) return y <= yearTo;
        return true;
      });

      if (!resultados.length) {
        mostrarMensaje(`No hay resultados en el rango ${yearFrom || 'âˆž'}â€“${yearTo || 'âˆž'}.`);
        return;
      }

      if (!yearFrom && !yearTo && resultados.length > 1) {
        mostrarOpcionesYear(resultados, urlInput);
        return;
      }

      mostrarResultado(resultados[0], urlInput);
    }

    function limpiarInterfaz() {
      document.getElementById("opciones-year").innerHTML = "";
      document.getElementById("poster").style.display = "none";
      document.getElementById("resultado").innerText = "";
    }

    function mostrarMensaje(texto) {
      limpiarInterfaz();
      document.getElementById("resultado").innerText = texto;
    }

    function mostrarOpcionesYear(lista, urlInput) {
      limpiarInterfaz();
      const cont = document.getElementById("opciones-year");
      const select = document.createElement("select");
      select.id = "yearSelector";
      select.style.padding = "5px";

      lista.forEach(movie => {
        const y = movie.release_date.split("-")[0];
        const opt = document.createElement("option");
        opt.value = movie.id;
        opt.text = `${movie.title} (${y})`;
        select.appendChild(opt);
      });
      cont.appendChild(select);

      const btn = document.createElement("button");
      btn.textContent = "Seleccionar";
      btn.style.marginLeft = "8px";
      btn.onclick = () => {
        const selId = parseInt(select.value);
        const movie = lista.find(m => m.id === selId);
        mostrarResultado(movie, urlInput);
      };
      cont.appendChild(btn);
    }

    function mostrarResultado(movie, videoUrl) {
      limpiarInterfaz();

      if (movie.poster_path) {
        const posterUrl = `https://image.tmdb.org/t/p/w500${movie.poster_path}`;
        const img = document.getElementById("poster");
        img.src = posterUrl;
        img.style.display = "block";
      }

      let overview = movie.overview || "Sinopsis no disponible";
      if (overview.length > 570) {
        overview = overview.substring(0, 567) + "...";
      }

      const year = movie.release_date.split("-")[0];
      const formattedTitle = movie.title.replace(/\s+/g, "_") + `(${year})`;
      const resultadoTexto =
        `ðŸ“‚ TÃ­tulo : \`${movie.title} (${year})\`\n\n`
        + `${overview}\n\n`
        + `http://labutacaroja.github.io/?video=${videoUrl}`
        + `&title=${formattedTitle}`;

      document.getElementById("resultado").innerText = resultadoTexto;
    }

    function limpiarCampos() {
      document.getElementById("titulo").value    = "";
      document.getElementById("yearFrom").value  = "";
      document.getElementById("yearTo").value    = "";
      document.getElementById("url").value       = "";
      limpiarInterfaz();
    }

    function copiarAlPortapapeles() {
      const txt = document.getElementById("resultado").innerText;
      navigator.clipboard.writeText(txt);
    }
  </script>
</body>
</html>
