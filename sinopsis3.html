<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Buscador de PelÃ­culas TMDb</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    input, button { padding: 10px; margin: 5px; }
    #resultado { margin-top: 20px; white-space: pre-wrap; background: #fff; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Buscador de PelÃ­culas TMDb</h1>
  <label for="titulo">TÃ­tulo (AÃ±o):</label>
  <input type="text" id="titulo" placeholder="Ej. La ciudad de la alegrÃ­a (1992!)">
  <br>
  <label for="url">URL:</label>
  <input type="text" id="url" size="80" placeholder="Pega aquÃ­ el enlace">
  <br>
  <button onclick="buscar()">Buscar</button>
  <button onclick="limpiar()">Limpiar campos</button>

  <div id="resultado"></div>

  <script>
    async function procesarUrlInteligente(url) {
      const streamPattern = /^https:\\/\\/stream\\.lcubots\\.news\\/V1\\/watch\\/[A-Za-z0-9]+$/;
      if (streamPattern.test(url)) {
        const proxy = 'https://api.allorigins.win/raw?url=';
        const target = proxy + encodeURIComponent(url);
        try {
          const resp = await fetch(target);
          const html = await resp.text();
          const match = html.match(/https:\\/\\/streamapi\\.mrfooll\\.xyz\\/[^\"']+/);
          return match ? match[0] : url;
        } catch (e) {
          console.warn('No se pudo resolver la URL de StreamAPI:', e);
          return url;
        }
      }

      // Limpieza avanzada para filetolink
      if (url.startsWith("https://filetolink")) {
        try {
          const u = new URL(url);
          const parts = u.pathname.split("/");
          if (parts.length >= 4 && parts[1] === "download") {
            u.pathname = `/${parts[2]}/`;
            return u.origin + u.pathname + u.search;
          }
        } catch (e) {
          console.warn("URL invÃ¡lida:", e);
        }
      }

      return url;
    }

    async function buscar() {
      const titulo = document.getElementById("titulo").value.trim();
      const url = document.getElementById("url").value.trim();
      if (!titulo || !url) {
        alert("Por favor, completa ambos campos.");
        return;
      }

      const urlProcesada = await procesarUrlInteligente(url);
      const enlaceFinal = `http://labutacaroja.github.io/?video=${encodeURIComponent(urlProcesada)}&title=${encodeURIComponent(titulo)}`;

      const resultado = `ðŸ“‚ Titulo : \`${titulo}\`\n${enlaceFinal}`;
      document.getElementById("resultado").textContent = resultado;
    }

    function limpiar() {
      document.getElementById("titulo").value = "";
      document.getElementById("url").value = "";
      document.getElementById("resultado").textContent = "";
    }
  </script>
</body>
</html>
